{% extends "layout.html" %}

{% block title %}FireSight - Wildfire Risk Dashboard{% endblock %}
{% block header %}Wildfire Risk Command Center{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Top stats strip -->
    <div class="stats-strip mb-md">
        <div class="stat-item">
            <div class="stat-label">Risk Level</div>
            <div class="stat-value danger">High</div>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-item">
            <div class="stat-label">Active Alerts</div>
            <div class="stat-value">3</div>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-item">
            <div class="stat-label">Average NDVI</div>
            <div class="stat-value warning">0.52</div>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-item">
            <div class="stat-label">Current Wind</div>
            <div class="stat-value">12 mph</div>
        </div>
        <div class="stat-divider"></div>
        <div class="stat-item">
            <div class="stat-label">Last Updated</div>
            <div class="stat-value text-muted">March 22, 08:45 AM</div>
        </div>
    </div>

    <!-- Main content grid -->
    <div class="dashboard-grid">
        <!-- Map panel -->
        <div class="panel panel-main">
            <div class="panel-header">
                <div class="panel-title">
                    <i class="fas fa-map-marked-alt"></i>
                    Risk Assessment Map
                </div>
                <div class="panel-actions">
                    <select class="form-select compact" id="mapLayerSelect">
                        <option value="risk">Risk Assessment</option>
                        <option value="ndvi">NDVI (Vegetation)</option>
                        <option value="nbr">NBR (Burn Ratio)</option>
                        <option value="terrain">Terrain</option>
                    </select>
                </div>
            </div>
            <div class="panel-body no-padding">
                <div id="mapContainer" class="map-container">
                    <div class="map-legend">
                        <div class="legend-title">Risk Levels</div>
                        <div class="legend-items">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: var(--risk-critical);"></div>
                                <div class="legend-label">Critical (>80%)</div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: var(--risk-high);"></div>
                                <div class="legend-label">High (60-80%)</div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: var(--risk-medium);"></div>
                                <div class="legend-label">Medium (40-60%)</div>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: var(--risk-low);"></div>
                                <div class="legend-label">Low (<40%)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Critical alerts panel -->
        <div class="panel panel-danger">
            <div class="panel-header">
                <div class="panel-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    Critical Alerts
                </div>
                <div class="panel-actions">
                    <button class="btn btn-text">View All</button>
                </div>
            </div>
            <div class="panel-body">
                <div class="alert-list">
                    <div class="alert-item critical pulse">
                        <div class="alert-header">
                            <div class="alert-title">
                                Northridge Canyon
                                <span class="alert-severity critical">Critical (89%)</span>
                            </div>
                            <div class="alert-actions">
                                <button class="btn btn-sm btn-danger">Deploy Resources</button>
                            </div>
                        </div>
                        <div class="alert-details">
                            Extreme dry conditions, increasing winds, and declining vegetation health (NDVI: 0.37)
                        </div>
                    </div>
                    <div class="alert-item high">
                        <div class="alert-header">
                            <div class="alert-title">
                                Eastern Foothills
                                <span class="alert-severity high">High (72%)</span>
                            </div>
                            <div class="alert-actions">
                                <button class="btn btn-sm btn-warning">Monitor</button>
                            </div>
                        </div>
                        <div class="alert-details">
                            Decreasing moisture levels, temperatures expected to rise to 92°F today
                        </div>
                    </div>
                    <div class="alert-item high">
                        <div class="alert-header">
                            <div class="alert-title">
                                Pine Ridge Forest
                                <span class="alert-severity high">High (68%)</span>
                            </div>
                            <div class="alert-actions">
                                <button class="btn btn-sm btn-warning">Monitor</button>
                            </div>
                        </div>
                        <div class="alert-details">
                            Limited access routes, dense vegetation with declining moisture content
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Indices trending panel -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">
                    <i class="fas fa-chart-line"></i>
                    Vegetation & Moisture Trends
                </div>
                <div class="panel-actions">
                    <select class="form-select compact" id="indexTimeRange">
                        <option value="7">Last 7 Days</option>
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                    </select>
                </div>
            </div>
            <div class="panel-body">
                <div class="chart-container">
                    <canvas id="indicesChart"></canvas>
                </div>
                <div class="index-summary">
                    <div class="index-stat declining">
                        <div class="index-label">NDVI</div>
                        <div class="index-value">0.52</div>
                        <div class="index-change negative">-18.8% in 7 days</div>
                    </div>
                    <div class="index-stat declining">
                        <div class="index-label">NBR</div>
                        <div class="index-value">0.18</div>
                        <div class="index-change negative">-43.8% in 7 days</div>
                    </div>
                    <div class="index-stat declining">
                        <div class="index-label">NDWI</div>
                        <div class="index-value">0.28</div>
                        <div class="index-change negative">-31.7% in 7 days</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Satellite imagery panel -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">
                    <i class="fas fa-satellite"></i>
                    Satellite Imagery
                </div>
                <div class="panel-actions">
                    <button class="btn btn-sm btn-outline">
                        <i class="fas fa-calendar-alt"></i> 
                        <span class="hide-mobile">Historical</span>
                    </button>
                    <a href="{{ url_for('upload') }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-upload"></i>
                        <span class="hide-mobile">Upload New</span>
                    </a>
                </div>
            </div>
            <div class="panel-body no-padding">
                <div class="image-viewer">
                    <div class="image-viewer-header">
                        <div class="image-viewer-title">Sentinel-2 • 2025-03-22</div>
                        <div class="image-viewer-controls">
                            <button class="btn btn-sm btn-dark">
                                <i class="fas fa-layer-group"></i>
                            </button>
                            <button class="btn btn-sm btn-dark">
                                <i class="fas fa-expand"></i>
                            </button>
                            <button class="btn btn-sm btn-dark">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                    <div class="image-viewer-body">
                        <img src="{{ url_for('static', filename='img/placeholder-image.jpg') }}" alt="Satellite Image" class="image-viewer-img">
                        <div class="band-selector">
                            <button class="band-pill active">Natural Color</button>
                            <button class="band-pill">False Color</button>
                            <button class="band-pill">NDVI</button>
                            <button class="band-pill">SWIR</button>
                        </div>
                    </div>
                    <div class="image-viewer-footer">
                        <button class="btn btn-sm btn-dark">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div class="image-viewer-meta">
                            <div class="meta-date">March 22, 2025</div>
                            <div class="meta-time">08:45 AM</div>
                        </div>
                        <button class="btn btn-sm btn-dark">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weather conditions panel -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">
                    <i class="fas fa-wind"></i>
                    Weather Conditions
                </div>
                <div class="panel-actions">
                    <button class="btn btn-sm btn-outline">Forecast</button>
                </div>
            </div>
            <div class="panel-body">
                <div class="weather-conditions">
                    <div class="weather-current">
                        <div class="weather-temperature">92°F</div>
                        <div class="weather-icon">
                            <i class="fas fa-sun"></i>
                        </div>
                        <div class="weather-description">Hot & Dry</div>
                    </div>
                    <div class="weather-details">
                        <div class="weather-detail">
                            <div class="detail-label">
                                <i class="fas fa-tint"></i> Humidity
                            </div>
                            <div class="detail-value alert">15%</div>
                        </div>
                        <div class="weather-detail">
                            <div class="detail-label">
                                <i class="fas fa-wind"></i> Wind
                            </div>
                            <div class="detail-value">12 mph E</div>
                        </div>
                        <div class="weather-detail">
                            <div class="detail-label">
                                <i class="fas fa-compass"></i> Pressure
                            </div>
                            <div class="detail-value">1012 hPa</div>
                        </div>
                        <div class="weather-detail">
                            <div class="detail-label">
                                <i class="fas fa-cloud-rain"></i> Precipitation
                            </div>
                            <div class="detail-value alert">0% chance</div>
                        </div>
                    </div>
                </div>
                <div class="fire-danger-meter">
                    <div class="danger-label">Fire Danger Index</div>
                    <div class="danger-meter">
                        <div class="danger-progress" style="width: 85%;"></div>
                    </div>
                    <div class="danger-level">Extreme (85/100)</div>
                </div>
            </div>
        </div>

        <!-- AI Assistant panel -->
        <div class="panel panel-dark">
            <div class="panel-header">
                <div class="panel-title">
                    <i class="fas fa-robot"></i>
                    FireSight AI Assistant
                </div>
                <div class="panel-actions">
                    <button class="btn btn-sm btn-outline-light">
                        <i class="fas fa-history"></i>
                        <span class="hide-mobile">History</span>
                    </button>
                </div>
            </div>
            <div class="panel-body">
                <div class="chatbot-container">
                    <div class="chatbot-messages">
                        <div class="chatbot-message system">
                            <div class="chatbot-message-content">
                                <p>Welcome to FireSight AI Assistant. How can I help with your wildfire assessment today?</p>
                            </div>
                        </div>
                    </div>
                    <div class="chatbot-footer">
                        <input type="text" id="chatInput" class="chatbot-input" placeholder="Ask about wildfire risks, terrain analysis, or request summaries...">
                        <button id="sendChatBtn" class="chatbot-button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize map
    const map = L.map('mapContainer').setView([34.052, -118.243], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Add some example data polygons
    const zones = [
        { name: "Northridge Canyon", coords: [[34.2, -118.5], [34.3, -118.5], [34.3, -118.4], [34.2, -118.4]], risk: "critical" },
        { name: "Eastern Foothills", coords: [[34.1, -118.2], [34.2, -118.2], [34.2, -118.1], [34.1, -118.1]], risk: "high" },
        { name: "Pine Ridge Forest", coords: [[34.0, -118.3], [34.1, -118.3], [34.1, -118.2], [34.0, -118.2]], risk: "high" },
        { name: "Valley Grasslands", coords: [[33.9, -118.4], [34.0, -118.4], [34.0, -118.3], [33.9, -118.3]], risk: "medium" }
    ];

    zones.forEach(zone => {
        let color;
        switch(zone.risk) {
            case "critical": color = "var(--risk-critical)"; break;
            case "high": color = "var(--risk-high)"; break;
            case "medium": color = "var(--risk-medium)"; break;
            default: color = "var(--risk-low)";
        }
        
        L.polygon(zone.coords, {
            color: color,
            fillOpacity: 0.7,
            weight: 2
        }).bindPopup(`
            <div class="map-popup">
                <div class="popup-title">${zone.name}</div>
                <div class="popup-risk ${zone.risk}">Risk: ${zone.risk}</div>
                <div class="popup-details">
                    <div class="popup-detail">
                        <span class="detail-label">NDVI:</span>
                        <span class="detail-value">0.52</span>
                    </div>
                    <div class="popup-detail">
                        <span class="detail-label">Terrain:</span>
                        <span class="detail-value">Canyon</span>
                    </div>
                    <div class="popup-detail">
                        <span class="detail-label">Vegetation:</span>
                        <span class="detail-value">Dense</span>
                    </div>
                </div>
                <button class="btn btn-sm btn-primary w-100">View Details</button>
            </div>
        `).addTo(map);
    });

    // Initialize chart
    const ctx = document.getElementById('indicesChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Mar 16', 'Mar 17', 'Mar 18', 'Mar 19', 'Mar 20', 'Mar 21', 'Mar 22'],
            datasets: [{
                label: 'NDVI',
                borderColor: 'var(--vegetation-green)',
                backgroundColor: 'rgba(45, 71, 57, 0.1)',
                data: [0.65, 0.64, 0.62, 0.59, 0.57, 0.54, 0.52],
                tension: 0.3,
                fill: true
            }, {
                label: 'NBR',
                borderColor: 'var(--danger)',
                backgroundColor: 'rgba(244, 67, 54, 0.1)',
                data: [0.32, 0.31, 0.30, 0.28, 0.25, 0.21, 0.18],
                tension: 0.3,
                fill: true
            }, {
                label: 'NDWI',
                borderColor: 'var(--water-blue)',
                backgroundColor: 'rgba(2, 136, 209, 0.1)',
                data: [0.41, 0.40, 0.38, 0.35, 0.32, 0.30, 0.28],
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        boxWidth: 12,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(38, 50, 56, 0.9)',
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    padding: 12,
                    cornerRadius: 4
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    min: 0,
                    max: 1,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            elements: {
                point: {
                    radius: 3,
                    hoverRadius: 5
                }
            }
        }
    });

    // Simple chat functionality
    document.getElementById('sendChatBtn').addEventListener('click', function() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if (text) {
            const messagesContainer = document.querySelector('.chatbot-messages');
            
            // Add user message
            const userMsg = document.createElement('div');
            userMsg.className = 'chatbot-message user';
            userMsg.innerHTML = `<div class="chatbot-message-content"><p>${text}</p></div>`;
            messagesContainer.appendChild(userMsg);
            
            // Clear input
            input.value = '';
            
            // Simulate AI response after a short delay
            setTimeout(() => {
                const aiMsg = document.createElement('div');
                aiMsg.className = 'chatbot-message system';
                
                let response;
                if (text.toLowerCase().includes('risk')) {
                    response = "Based on current data, Northridge Canyon shows the highest risk due to dry vegetation (NDVI: 0.52) and weather conditions. I recommend focusing resources on this area first.";
                } else if (text.toLowerCase().includes('weather')) {
                    response = "Local weather forecast shows high temperatures (92°F) and low humidity (15%) for the next 48 hours with winds from the east at 12mph. These conditions may accelerate wildfire spread in vulnerable areas.";
                } else {
                    response = "I can provide information about wildfire risks, vegetation indices, terrain analysis, and recommended actions. What specific information would you like?";
                }
                
                aiMsg.innerHTML = `<div class="chatbot-message-content"><p>${response}</p></div>`;
                messagesContainer.appendChild(aiMsg);
                
                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 1000);
        }
    });

    // Allow sending message with Enter key
    document.getElementById('chatInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('sendChatBtn').click();
        }
    });

    // Layer selector change event
    document.getElementById('mapLayerSelect').addEventListener('change', function() {
        const selectedValue = this.value;
        // In a real implementation, you would switch the map layers here
        console.log(`Map layer changed to: ${selectedValue}`);
    });

    // Time range selector change event
    document.getElementById('indexTimeRange').addEventListener('change', function() {
        const selectedValue = this.value;
        // In a real implementation, you would update the chart data here
        console.log(`Time range changed to: ${selectedValue} days`);
    });

    // Band selector functionality
    document.querySelectorAll('.band-pill').forEach(pill => {
        pill.addEventListener('click', function() {
            document.querySelectorAll('.band-pill').forEach(p => p.classList.remove('active'));
            this.classList.add('active');
            // In a real implementation, you would switch the image band here
            console.log(`Image band changed to: ${this.textContent}`);
        });
    });
</script>
{% endblock %}
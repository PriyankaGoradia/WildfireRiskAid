<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FireSight - Upload Satellite Images</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">FireSight</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/upload">Upload</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/analyze">Analysis</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h1>Upload Satellite Imagery</h1>
        
        <ul class="nav nav-tabs" id="uploadTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="file-tab" data-bs-toggle="tab" data-bs-target="#file-upload" type="button" role="tab">File Upload</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="api-tab" data-bs-toggle="tab" data-bs-target="#api-upload" type="button" role="tab">API Integration</button>
            </li>
        </ul>
        
        <div class="tab-content mt-3" id="uploadTabsContent">
            <div class="tab-pane fade show active" id="file-upload" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Upload Satellite Image</h5>
                        <p class="card-text">Upload satellite imagery files for wildfire risk analysis.</p>
                        
                        <form id="satelliteUploadForm" enctype="multipart/form-data">
                            <input type="hidden" name="upload_type" value="satellite">
                            
                            <div class="mb-3">
                                <label for="satelliteImage" class="form-label">Satellite Image File</label>
                                <input class="form-control" type="file" id="satelliteImage" name="satellite_image" accept=".tif,.tiff,.jp2,.png">
                                <div class="form-text">Supported formats: GeoTIFF, JPEG 2000, GeoJSON</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="acquisitionDate" class="form-label">Acquisition Date</label>
                                <input type="date" class="form-control" id="acquisitionDate" name="acquisition_date">
                            </div>
                            
                            <div class="mb-3">
                                <label for="sensorType" class="form-label">Sensor Type</label>
                                <select class="form-select" id="sensorType" name="sensor_type">
                                    <option value="Landsat-8">Landsat-8</option>
                                    <option value="Landsat-9">Landsat-9</option>
                                    <option value="Sentinel-2">Sentinel-2</option>
                                    <option value="MODIS">MODIS</option>
                                    <option value="VIIRS">VIIRS</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="resolution" class="form-label">Resolution (meters)</label>
                                <input type="number" class="form-control" id="resolution" name="resolution" step="0.1" min="0.1">
                            </div>
                            
                            <div class="mb-3">
                                <label for="region" class="form-label">Region Name</label>
                                <input type="text" class="form-control" id="region" name="region">
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Upload</button>
                        </form>
                        
                        <div class="mt-3" id="uploadProgress" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                            </div>
                            <p class="mt-2" id="uploadStatus">Uploading...</p>
                        </div>
                        
                        <div class="alert alert-success mt-3" id="uploadSuccess" style="display: none;"></div>
                        <div class="alert alert-danger mt-3" id="uploadError" style="display: none;"></div>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="api-upload" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">API Integration</h5>
                        <p class="card-text">Connect to satellite data providers or upload processed statistics directly.</p>
                        
                        <div class="mb-3">
                            <label for="apiProvider" class="form-label">Select Provider</label>
                            <select class="form-select" id="apiProvider">
                                <option value="earth_engine">Google Earth Engine</option>
                                <option value="sentinel_hub">Sentinel Hub</option>
                                <option value="nasa_firms">NASA FIRMS</option>
                                <option value="custom">Custom API</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="apiKey" class="form-label">API Key</label>
                            <input type="password" class="form-control" id="apiKey">
                        </div>
                        
                        <div class="mb-3">
                            <label for="jsonStats" class="form-label">Direct Statistics JSON</label>
                            <textarea class="form-control" id="jsonStats" rows="10" placeholder="{
  &quot;image_name&quot;: &quot;example_image&quot;,
  &quot;acquisition_date&quot;: &quot;2025-03-15T00:00:00&quot;,
  &quot;sensor_type&quot;: &quot;Sentinel-2&quot;,
  &quot;resolution&quot;: 10.0,
  &quot;spectral_bands&quot;: [],
  &quot;spectral_indices&quot;: []
}"></textarea>
                        </div>
                        
                        <button id="apiUploadBtn" class="btn btn-primary">Upload API Data</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <h2>Recently Uploaded Images</h2>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Image Name</th>
                            <th>Acquisition Date</th>
                            <th>Sensor</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recentUploads">
                        <!-- Will be populated via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Fetch recent uploads on page load
        document.addEventListener('DOMContentLoaded', function() {
            fetchRecentUploads();
            
            // Set up the file upload form
            document.getElementById('satelliteUploadForm').addEventListener('submit', function(e) {
                e.preventDefault();
                uploadSatelliteImage();
            });
            
            // Set up the API data upload
            document.getElementById('apiUploadBtn').addEventListener('click', function() {
                uploadApiData();
            });
        });
        
        function fetchRecentUploads() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('recentUploads');
                    tableBody.innerHTML = '';
                    
                    if (data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No images uploaded yet</td></tr>';
                        return;
                    }
                    
                    data.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.stats_id}</td>
                            <td>${item.image_name}</td>
                            <td>${new Date(item.acquisition_date).toLocaleDateString()}</td>
                            <td>${item.sensor_type}</td>
                            <td>
                                <a href="/analyze/${item.stats_id}" class="btn btn-sm btn-primary">Analyze</a>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error fetching recent uploads:', error);
                });
        }
        
        function uploadSatelliteImage() {
            const form = document.getElementById('satelliteUploadForm');
            const formData = new FormData(form);
            
            // Show progress
            const progressBar = document.querySelector('#uploadProgress .progress-bar');
            const uploadStatus = document.getElementById('uploadStatus');
            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('uploadSuccess').style.display = 'none';
            document.getElementById('uploadError').style.display = 'none';
            
            // Upload the image
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Upload failed: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('uploadSuccess').style.display = 'block';
                document.getElementById('uploadSuccess').textContent = data.message;
                
                // Reset form
                form.reset();
                
                // Refresh the recent uploads table
                fetchRecentUploads();
            })
            .catch(error => {
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('uploadError').style.display = 'block';
                document.getElementById('uploadError').textContent = error.message;
            });
        }
        
        function uploadApiData() {
            const jsonData = document.getElementById('jsonStats').value;
            const provider = document.getElementById('apiProvider').value;
            
            try {
                // Parse JSON to validate it
                const statsData = JSON.parse(jsonData);
                
                // Upload the data
                fetch('/upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: jsonData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('API upload failed: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    alert('API data uploaded successfully!');
                    fetchRecentUploads();
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                });
            } catch (e) {
                alert('Invalid JSON data. Please check the format.');
            }
        }
    </script>
</body>
</html>